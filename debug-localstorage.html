<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug localStorage - Kho V·∫£i T√¥n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .data-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .override-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            color: #856404;
        }
        .clean-data {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            color: #155724;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        #results {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug localStorage</h1>
        <p>Ki·ªÉm tra localStorage c√≥ ƒëang override gi√° ti·ªÅn kh√¥ng</p>
        
        <button onclick="checkLocalStorage()">Ki·ªÉm tra localStorage</button>
        <button onclick="analyzeOverrides()">Ph√¢n t√≠ch overrides</button>
        <button onclick="clearLocalStorage()" class="danger">X√≥a localStorage</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="localStorageData"></div>
        <div id="results"></div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        const localStorageDataDiv = document.getElementById('localStorageData');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.textContent += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            console.log(message);
        }
        
        function clearResults() {
            resultsDiv.textContent = '';
            localStorageDataDiv.innerHTML = '';
        }
        
        function checkLocalStorage() {
            log('üîç Checking localStorage for fabric updates...');
            
            const fabricUpdates = localStorage.getItem('fabric-updates');
            
            if (!fabricUpdates) {
                log('‚úÖ No fabric-updates found in localStorage');
                localStorageDataDiv.innerHTML = '<div class="clean-data">‚úÖ localStorage is clean - no fabric updates found</div>';
                return;
            }
            
            try {
                const updates = JSON.parse(fabricUpdates);
                const updateCount = Object.keys(updates).length;
                
                log(`üìä Found ${updateCount} fabric updates in localStorage`);
                
                localStorageDataDiv.innerHTML = `
                    <h3>üìä localStorage Data (${updateCount} updates)</h3>
                    <div class="code-block">${JSON.stringify(updates, null, 2)}</div>
                `;
                
                // Analyze each update
                Object.entries(updates).forEach(([fabricId, update]) => {
                    analyzeUpdate(fabricId, update);
                });
                
            } catch (error) {
                log(`‚ùå Error parsing localStorage data: ${error.message}`);
                localStorageDataDiv.innerHTML = '<div class="override-warning">‚ùå Error parsing localStorage data</div>';
            }
        }
        
        function analyzeUpdate(fabricId, update) {
            log(`\nüîç Analyzing update for fabric ${fabricId}:`);
            log(`   price: ${update.price} (type: ${typeof update.price})`);
            log(`   priceNote: ${update.priceNote}`);
            log(`   isHidden: ${update.isHidden}`);
            log(`   customImageUrl: ${update.customImageUrl}`);
            log(`   updatedAt: ${update.updatedAt}`);
            
            // Check for problematic overrides
            const issues = [];
            
            if (update.price === null) {
                issues.push('‚ö†Ô∏è Price is null - will override any Supabase price');
            }
            
            if (update.price === undefined) {
                issues.push('‚ÑπÔ∏è Price is undefined - will not override Supabase price');
            }
            
            if (typeof update.price === 'string') {
                issues.push('‚ö†Ô∏è Price is string - should be number');
            }
            
            if (update.price === 0) {
                issues.push('‚ö†Ô∏è Price is 0 - might be intentional or error');
            }
            
            // Create visual representation
            const updateDiv = document.createElement('div');
            updateDiv.className = 'data-item';
            
            const hasIssues = issues.length > 0;
            const statusClass = hasIssues ? 'override-warning' : 'clean-data';
            const statusIcon = hasIssues ? '‚ö†Ô∏è' : '‚úÖ';
            
            updateDiv.innerHTML = `
                <h4>Fabric ${fabricId}</h4>
                <div class="${statusClass}">
                    ${statusIcon} ${hasIssues ? 'Has potential issues' : 'Looks good'}
                </div>
                <div class="code-block">
                    price: ${JSON.stringify(update.price)} (${typeof update.price})<br>
                    priceNote: ${JSON.stringify(update.priceNote)}<br>
                    isHidden: ${JSON.stringify(update.isHidden)}<br>
                    customImageUrl: ${JSON.stringify(update.customImageUrl)}<br>
                    updatedAt: ${update.updatedAt}
                </div>
                ${issues.length > 0 ? `
                    <div class="override-warning">
                        <strong>Issues:</strong><br>
                        ${issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                    </div>
                ` : ''}
                <button onclick="removeUpdate(${fabricId})" class="danger">Remove this update</button>
            `;
            
            localStorageDataDiv.appendChild(updateDiv);
        }
        
        function analyzeOverrides() {
            log('üîç Analyzing localStorage overrides...');
            
            const fabricUpdates = localStorage.getItem('fabric-updates');
            
            if (!fabricUpdates) {
                log('‚úÖ No overrides to analyze');
                return;
            }
            
            try {
                const updates = JSON.parse(fabricUpdates);
                const priceOverrides = [];
                const hiddenOverrides = [];
                const imageOverrides = [];
                
                Object.entries(updates).forEach(([fabricId, update]) => {
                    if (update.price !== undefined) {
                        priceOverrides.push({ fabricId, price: update.price, note: update.priceNote });
                    }
                    if (update.isHidden !== undefined) {
                        hiddenOverrides.push({ fabricId, isHidden: update.isHidden });
                    }
                    if (update.customImageUrl !== undefined) {
                        imageOverrides.push({ fabricId, url: update.customImageUrl });
                    }
                });
                
                log(`\nüìä Override Summary:`);
                log(`   üí∞ Price overrides: ${priceOverrides.length}`);
                log(`   üëÅÔ∏è Visibility overrides: ${hiddenOverrides.length}`);
                log(`   üñºÔ∏è Image overrides: ${imageOverrides.length}`);
                
                if (priceOverrides.length > 0) {
                    log(`\nüí∞ Price Overrides:`);
                    priceOverrides.forEach(({ fabricId, price, note }) => {
                        log(`   Fabric ${fabricId}: ${price} VND ${note ? `(${note})` : ''}`);
                    });
                }
                
                if (hiddenOverrides.length > 0) {
                    log(`\nüëÅÔ∏è Visibility Overrides:`);
                    hiddenOverrides.forEach(({ fabricId, isHidden }) => {
                        log(`   Fabric ${fabricId}: ${isHidden ? 'Hidden' : 'Visible'}`);
                    });
                }
                
                if (imageOverrides.length > 0) {
                    log(`\nüñºÔ∏è Image Overrides:`);
                    imageOverrides.forEach(({ fabricId, url }) => {
                        log(`   Fabric ${fabricId}: ${url}`);
                    });
                }
                
            } catch (error) {
                log(`‚ùå Error analyzing overrides: ${error.message}`);
            }
        }
        
        function removeUpdate(fabricId) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a update cho fabric ${fabricId}?`)) {
                return;
            }
            
            try {
                const fabricUpdates = localStorage.getItem('fabric-updates');
                if (fabricUpdates) {
                    const updates = JSON.parse(fabricUpdates);
                    delete updates[fabricId];
                    localStorage.setItem('fabric-updates', JSON.stringify(updates));
                    log(`‚úÖ Removed update for fabric ${fabricId}`);
                    
                    // Refresh display
                    checkLocalStorage();
                }
            } catch (error) {
                log(`‚ùå Error removing update: ${error.message}`);
            }
        }
        
        function clearLocalStorage() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu localStorage? ƒêi·ªÅu n√†y s·∫Ω x√≥a t·∫•t c·∫£ c√°c thay ƒë·ªïi gi√°, ·∫©n/hi·ªán, v√† URL ·∫£nh t√πy ch·ªânh.')) {
                return;
            }
            
            try {
                localStorage.removeItem('fabric-updates');
                log('‚úÖ Cleared all localStorage data');
                localStorageDataDiv.innerHTML = '<div class="clean-data">‚úÖ localStorage cleared successfully</div>';
                
                // Also clear other related localStorage items
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('fabric') || key.includes('image') || key.includes('price'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    log(`üóëÔ∏è Removed ${key}`);
                });
                
                log(`\nüéâ localStorage cleanup complete!`);
                log(`üí° Refresh the sale page to see if prices now display correctly`);
                
            } catch (error) {
                log(`‚ùå Error clearing localStorage: ${error.message}`);
            }
        }
        
        // Auto-run on load
        window.addEventListener('load', () => {
            log('üöÄ localStorage debug tool loaded');
            log('üìã This tool helps debug localStorage overrides that might hide prices');
            log('');
            
            // Auto-check localStorage
            setTimeout(checkLocalStorage, 500);
        });
    </script>
</body>
</html>
